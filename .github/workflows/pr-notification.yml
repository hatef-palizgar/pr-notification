name: PR Notifications

on:
  pull_request:
    types:
      [
        opened,
        synchronize,
        reopened,
        ready_for_review,
        review_requested,
        edited,
      ]

jobs:
  notify-teams:
    runs-on: ubuntu-latest
    env:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    steps:
      - name: Extract services from PR title
        id: extract-services
        run: |
          # Define service-to-team mapping with channel IDs
          declare -A service_team_mapping
          # Format: service_team_mapping["service-name"]="channel-name"
          service_team_mapping["meal-break"]="followup-team"
          service_team_mapping["overtime-methods"]="followup-team"
          service_team_mapping["salaries"]="followup-team"
          service_team_mapping["tags"]="followup-team"
          service_team_mapping["time-punch"]="followup-team"
          # More teams and services will be added later

          # Get PR title
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Extract content between parentheses
          if [[ $PR_TITLE =~ \((.*?)\) ]]; then
            CONTENT_IN_BRACKETS="${BASH_REMATCH[1]}"
            
            # Split by comma and process each item
            declare -A affected_teams
            
            IFS=',' read -ra ITEMS <<< "$CONTENT_IN_BRACKETS"
            for item in "${ITEMS[@]}"; do
              # Trim whitespace
              item=$(echo "$item" | xargs)
              
              # Convert to uppercase for comparison
              UPPER_ITEM=$(echo "$item" | tr '[:lower:]' '[:upper:]')
              
              # Skip if it's a Jira ticket (matches QRND-number format, case insensitive)
              if [[ ! $UPPER_ITEM =~ ^QRND-[0-9]+$ ]]; then
                # Look up team name from service name
                if [[ -n "${service_team_mapping[$item]}" ]]; then
                  affected_teams["${service_team_mapping[$item]}"]=1
                fi
              fi
            done

            # Extract Jira ticket if present (case insensitive)
            JIRA_TICKET=""
            for item in "${ITEMS[@]}"; do
              item=$(echo "$item" | xargs)
              UPPER_ITEM=$(echo "$item" | tr '[:lower:]' '[:upper:]')
              if [[ $UPPER_ITEM =~ ^QRND-[0-9]+$ ]]; then
                JIRA_TICKET=$item
                break
              fi
            done

            # Send notification to each affected team
            for channel in "${!affected_teams[@]}"; do
              echo "Sending notification to channel: ${channel}"
              
              # Prepare the message payload
              MESSAGE="New PR Notification
                *PR:* $PR_TITLE
                *Link:* ${{ github.event.pull_request.html_url }}
                *PR Number:* ${{ github.event.pull_request.number }}"

              if [[ -n "$JIRA_TICKET" ]]; then
                MESSAGE="$MESSAGE
                *Jira Ticket:* $JIRA_TICKET"
              fi

              # Send message using chat.postMessage API
              curl -X POST \
                -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                -H "Content-type: application/json" \
                -d "{\"channel\":\"${channel}\",\"text\":\"${MESSAGE}\",\"parse\":\"full\"}" \
                https://slack.com/api/chat.postMessage
            done
          fi

